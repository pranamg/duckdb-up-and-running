-- Flights DB Schema

-- Sequences
CREATE SEQUENCE flight_id_seq START 1 INCREMENT BY 1 NO CYCLE;
CREATE SEQUENCE airport_id_seq START 1 INCREMENT BY 1 NO CYCLE;
CREATE SEQUENCE airline_id_seq START 1 INCREMENT BY 1 NO CYCLE;

-- Airports Table
CREATE TABLE airports (
    id INTEGER PRIMARY KEY DEFAULT nextval('airport_id_seq'),
    IATA_CODE VARCHAR NOT NULL UNIQUE,
    AIRPORT VARCHAR NOT NULL,
    CITY VARCHAR,
    STATE VARCHAR,
    COUNTRY VARCHAR,
    LATITUDE DOUBLE,
    LONGITUDE DOUBLE
);

-- Airlines Table
CREATE TABLE airlines (
    id INTEGER PRIMARY KEY DEFAULT nextval('airline_id_seq'),
    IATA_CODE VARCHAR NOT NULL UNIQUE,
    AIRLINE VARCHAR NOT NULL
);

-- Airports Location Table
CREATE TABLE airports_location (
    IATA_CODE VARCHAR PRIMARY KEY,
    LATITUDE DOUBLE,
    LONGITUDE DOUBLE
);

-- Flights Table
CREATE TABLE flights (
    id INTEGER PRIMARY KEY DEFAULT nextval('flight_id_seq'),
    YEAR INTEGER,
    MONTH INTEGER,
    DAY INTEGER,
    DAY_OF_WEEK INTEGER,
    AIRLINE VARCHAR NOT NULL,
    FLIGHT_NUMBER VARCHAR,
    ORIGIN_AIRPORT VARCHAR NOT NULL,
    DESTINATION_AIRPORT VARCHAR NOT NULL,
    SCHEDULED_DEPARTURE VARCHAR,
    DEPARTURE_TIME VARCHAR,
    DEPARTURE_DELAY INTEGER,
    SCHEDULED_ARRIVAL VARCHAR,
    ARRIVAL_TIME VARCHAR,
    ARRIVAL_DELAY INTEGER,
    CANCELLED INTEGER,
    DIVERTED INTEGER,
    AIR_TIME INTEGER,
    DISTANCE INTEGER,
    FOREIGN KEY (AIRLINE) REFERENCES airlines(IATA_CODE),
    FOREIGN KEY (ORIGIN_AIRPORT) REFERENCES airports(IATA_CODE),
    FOREIGN KEY (DESTINATION_AIRPORT) REFERENCES airports(IATA_CODE)
);

-- Views
CREATE OR REPLACE VIEW v_flight_counts_per_airport AS
SELECT ORIGIN_AIRPORT, COUNT(*) AS departures
FROM flights
GROUP BY ORIGIN_AIRPORT;

CREATE OR REPLACE VIEW v_airline_performance AS
SELECT AIRLINE, AVG(ARRIVAL_DELAY) AS avg_arrival_delay, COUNT(*) AS total_flights
FROM flights
GROUP BY AIRLINE;

CREATE OR REPLACE VIEW v_airport_locations AS
SELECT a.IATA_CODE, a.AIRPORT, a.CITY, a.STATE, a.COUNTRY, l.LATITUDE, l.LONGITUDE
FROM airports a
LEFT JOIN airports_location l ON a.IATA_CODE = l.IATA_CODE;



